<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>XMLHttpRequest</title>
</head>
<body>
	<h1>XMLHttpRequest</h1>

	<h5>게시글 조회</h5>
	<label for="no">게시글 번호</label>
	<input type="text" name="no" id="no">
	<button onclick="getBoard()">조회</button>
	<hr>

	<div>
		<h5>조회된 게시글 정보</h5>
		<h3><span>제목 : </span><span id="title"></span></h3>
		<h3><span>작성자 : </span><span id="writer"></span></h3>
		<textarea id="content" cols="50" rows="10" readonly></textarea>
	</div>

	<hr>

	<h3>게시글 등록/수정/삭제</h3>
	<form action="api/boards" method="post">
		<table>
			<tr>
				<td><label for="title">제목</label></td>
				<td><input type="text" name="title" id="input-title"></td>
			</tr>
			<tr>
				<td><label for="writer">작성자</label></td>
				<td><input type="text" name="writer" id="input-writer"></td>
			</tr>
			<tr>
				<td><label for="content">내용</label></td>
				<td>
					<textarea name="content" id="input-content" cols="50" rows="10"></textarea>
				</td>
			</tr>
			<tr>
				<td><label for="updateNo">글번호</label></td>
				<td><input type="text" name="no" id="input-no" placeholder="수정/삭제 번호"></td>
			</tr>
		</table>
		<button type="button" onclick="insert()">등록하기</button>
		<button type="button" onclick="update()">수정하기</button>
		<button type="button" onclick="remove()">삭제하기</button>
	</form>


	<hr>

	<h3>게시글 목록</h3>
	<table id="board-list" border="1">
		<tr id="board-title">
			<th width="50">번호</th>
			<th width="300">제목</th>
			<th width="100">작성자</th>
			<th width="200">등록일자</th>
			<th width="200">수정일자</th>
		</tr>
		<tbody id="board-body">
			<tr id="board-data">
				<td colspan="5" align="center">조회된 데이터가 없습니다.</td>
			</tr>
		</tbody>
	</table>

	<script>
		let request
		// 게시글 조회
		function getBoard() {
			// XMLHttpRequest 객체 생성
			request = new XMLHttpRequest()
			
			// 입력한 글 번호 가져오기
			let no = document.getElementById("no").value
			
			// 요청 설정
			let url = `http://127.0.0.1:8080/api/boards/${no}`
			request.open('GET', url, true)
			
			// onload : 
			// 요청 완료 및 응답 성공
			// request.responseText = 응답 데이터
			request.onload = function() {
				let response = ''

				if ( request.status == 200 ) {
					response = request.responseText

					if ( response == '' ) {
						alert('응답된 데이터가 없습니다.')
					}
					else {
						// JSON.parse() : JSON문자열 -> JS 객체 변환
						let board = JSON.parse(response)
						
						let title = document.getElementById("title")
						let writer = document.getElementById("writer")
						let content = document.getElementById("content")
						
						title.textContent = board.title
						writer.textContent = board.writer
						content.textContent = board.content
						}

				}


			}

			// 응답 확인 - 준비상태 변경 이벤트 핸들러
			// request.onreadystatechange = function() {
			// 	let response = ''
				
			// 	// 요청 완료 및 응답 성공
			// 	if ( request.readyState == request.DONE && request.status == 200 ) {
			// 		// request.responseText = 응답 데이터
			// 		response = request.responseText
					
			// 		if ( response == '' ) {
			// 			alert('응답된 데이터가 없습니다.')
			// 		}
			// 		else {
			// 			// JSON.parse() : JSON문자열 -> JS 객체 변환
			// 			let board = JSON.parse(response)
						
			// 			let title = document.getElementById("title")
			// 			let writer = document.getElementById("writer")
			// 			let content = document.getElementById("content")
						
			// 			title.textContent = board.title
			// 			writer.textContent = board.writer
			// 			content.textContent = board.content
			// 		}
					
			// 	}
			// }
			
			// 요청 전송
			request.send()
			
		}

		// 게시글 조회
		function getList() {
			// XMLHttpRequest 객체 생성
			request = new XMLHttpRequest()
			
			// 요청 설정
			let url = `http://127.0.0.1:8080/api/boards`
			request.open('GET', url, true)
			
			// onload : 
			// 요청 완료 및 응답 성공
			request.onload = function() {
				let response = ''

				if ( request.status == 200 ) {
					response = request.responseText

					let boardList = JSON.parse(response)

					// 데이터가 없을 때
					if ( boardList.length == 0 ) {
						alert('응답된 데이터가 없습니다.')
					}

					// 데이터 있을 때
					else {
						let $boardData = document.getElementById('board-data')
						let $boardList = document.getElementById('board-list')
						let $boardBody = document.getElementById('board-body')
						// 데이터 초기화
						// $boardData.remove()
						$boardBody.innerHTML = ''

						let tr = '' 
						for( const board of boardList ) {
							tr += `<tr>
									   <td>${board.no}</td>
									   <td>${board.title}</td>
									   <td>${board.writer}</td>
									   <td>${board.createdAt}</td>
									   <td>${board.updatedAt}</td>
								   </tr>`
						}
						$boardBody.innerHTML = tr
						
					}

				}

			}
	
			// 요청 전송
			request.send()
			
		}
		// 게시글 목록 함수 호출
		getList()

		// 게시글 등록
		function insert() {
			request = new XMLHttpRequest()

			// 입력정보
			let title = document.getElementById("input-title").value
			let writer = document.getElementById("input-writer").value
			let content = document.getElementById("input-content").value

			// 객체
			let data = {
				'title' : title,
				'writer' : writer,
				'content' : content,
			}

			// 요청 설정
			let url = `http://127.0.0.1:8080/api/boards`
			request.open('POST', url, true)

			// 헤더 설정
			request.setRequestHeader("Content-Type", "application/json")

			// 응답 확인
			request.onload = function() {
				let response = ''
				if ( request.status == 201 ) {
					response = request.responseText
					alert(response)
					// 등록 후 목록 갱신
					getList()
				}

				if ( request.status == 400 ) {
					alert("클라이언트의 잘못된 요청")
				}

				if ( request.status == 500 ) {
					alert("서버 내부 에러")
				}
			}
			// 요청 전송
			// JSON.stringify() : JS 객체 -> JSON 문자열 변환
			request.send( JSON.stringify(data) )
		}

		// 게시글 수정
		function update() {
			request = new XMLHttpRequest()

			// 입력 정보
			let no = document.getElementById("input-no").value
			let title = document.getElementById("input-title").value
			let writer = document.getElementById("input-writer").value
			let content = document.getElementById("input-content").value

			// 객체
			let data = {
				'no' : no,
				'title' : title,
				'writer' : writer,
				'content' : content
			}

			// 요청 설정
			let url = `http://127.0.0.1:8080/api/boards`
			request.open('PUT', url, true)

			// 헤더 설정
			request.setRequestHeader("Content-Type", "application/json")

			// 응답 확인
			request.onload = function() {
				let response = ''

				// 요청 성공
				if ( request.status == 200 ) {
					response = request.responseText
					alert(response)
					getList()
				}

				// 요청 실패
				if ( request.status == 400 ) {
					alert("클라이언트의 잘못된 요청")
				}

				if ( request.status == 500 ) {
					alert("서버 내부 에러")
				}

			}
			// 요청 전송
			// JSON.stringify(data) : 객체 --> JSON 문자열로 변환
			request.send( JSON.stringify(data) )
		}

		// 게시글 삭제
		function remove() {
			request = new XMLHttpRequest()

			// 입력 정보
			let no = document.getElementById("input-no").value

			// DELETE 요청 방식은 요청 데이터를 URL 에 포함하여 전송한다
			// 요청 설정
			let url = `http://127.0.0.1:8080/api/boards/${no}`
			request.open('DELETE', url, true)

			// 응답 확인
			request.onload = function() {
				let response = ''

				// 요청 성공
				if ( request.status == 200 ) {
					response = request.responseText
					alert(response)
					getList()
				}

				// 요청 실패
				if ( request.status == 400 ) {
					alert("클라이언트의 잘못된 요청")
				}

				if ( request.status == 500 ) {
					alert("서버 내부 에러")
				}

			}
			// 요청 전송
			request.send()
		}
		</script>
</body>
</html>