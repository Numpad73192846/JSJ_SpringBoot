<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>fetch</title>
</head>
<body>
	<h1>fetch</h1>

	<h5>게시글 조회</h5>
	<label for="no">게시글 번호</label>
	<input type="text" name="no" id="no">
	<button onclick="getBoard()">조회</button>
	<hr>

	<div>
		<h5>조회된 게시글 정보</h5>
		<h3><span>제목 : </span><span id="title"></span></h3>
		<h3><span>작성자 : </span><span id="writer"></span></h3>
		<textarea id="content" cols="50" rows="10" readonly></textarea>
	</div>

	<hr>

	<h3>게시글 등록/수정/삭제</h3>
	<form action="api/boards" method="post">
		<table>
			<tr>
				<td><label for="title">제목</label></td>
				<td><input type="text" name="title" id="input-title"></td>
			</tr>
			<tr>
				<td><label for="writer">작성자</label></td>
				<td><input type="text" name="writer" id="input-writer"></td>
			</tr>
			<tr>
				<td><label for="content">내용</label></td>
				<td>
					<textarea name="content" id="input-content" cols="50" rows="10"></textarea>
				</td>
			</tr>
			<tr>
				<td><label for="updateNo">글번호</label></td>
				<td><input type="text" name="no" id="input-no" placeholder="수정/삭제 번호"></td>
			</tr>
		</table>
		<button type="button" onclick="insert()">등록하기</button>
		<button type="button" onclick="update()">수정하기</button>
		<button type="button" onclick="remove()">삭제하기</button>
	</form>


	<hr>

	<h3>게시글 목록</h3>
	<table id="board-list" border="1">
		<tr id="board-title">
			<th width="50">번호</th>
			<th width="300">제목</th>
			<th width="100">작성자</th>
			<th width="200">등록일자</th>
			<th width="200">수정일자</th>
		</tr>
		<tbody id="board-body">
			<tr id="board-data">
				<td colspan="5" align="center">조회된 데이터가 없습니다.</td>
			</tr>
		</tbody>
	</table>

	<script>
		let request
		// 게시글 조회
		function getBoard() {
			// 입력한 글 번호 가져오기
			let no = document.getElementById("no").value
			
			// 요청 설정
			let url = `http://127.0.0.1:8080/api/boards/${no}`
			
			// FETCH API 로 게시글 조회요청
			fetch(url)				// Promise 객체 반환
				// then() 		: 서버로 부터 응답이 왔을 때 호출 되는 메서드
				// response 	: 상태코드, 헤더, 본문 등의 응답 객체 정보
				.then(response => {
					// 요청 성공
					if ( response.ok ) {
						// JSON 문자열 -> JS 객체 변환
						return response.json()
					}
					else {
						alert('데이터 조회에 실패했습니다.')
						throw new Error("조회 실패")
					}
				})

				.then( board => {
					if ( !board ) {
						alert('응답된 데이터가 없습니다.')
					}
					else {
						let title = document.getElementById("title")
						let writer = document.getElementById("writer")
						let content = document.getElementById("content")

						title.textContent = board.title
						writer.textContent = board.writer
						content.textContent = board.content
					}
				})

				.catch( error => {
					console.log(error)
					console.dir(error)
					alert('게시글 조회 요청 중 에러가 발생하였습니다.')
				})
		}

		// 게시글 조회
		function getList() {
			// 요청 설정
			let url = `http://127.0.0.1:8080/api/boards`
			
			fetch(url)
				.then( response => {
					// 요청 성공 확인
					if ( response.ok ) {
						// JSON 문자열 -> JS 객체로 변환
						return response.json()
					}
					else {
						throw new Error("목록 조회 실패");
					}
				})

				.then( boardList => {
					// 데이터가 없을 때
					if ( boardList.length == 0 ) {
						alert('응답된 데이터가 없습니다.')
					}

					// 데이터가 있을 때
					else {
						let $boardBody = document.getElementById('board-body')
						// 데이터 초기화
						// $boardData.remove()
						$boardBody.innerHTML = ''

						let tr = '' 
						for( const board of boardList ) {
							tr += `<tr>
									   <td>${board.no}</td>
									   <td>${board.title}</td>
									   <td>${board.writer}</td>
									   <td>${board.createdAt}</td>
									   <td>${board.updatedAt}</td>
								   </tr>`
						}
						$boardBody.innerHTML = tr
					}
				})

		}
		// 게시글 목록 함수 호출
		getList()

		// 게시글 등록
		function insert() {
			// 입력정보
			let title = document.getElementById("input-title").value
			let writer = document.getElementById("input-writer").value
			let content = document.getElementById("input-content").value

			// 객체
			let data = {
				'title' : title,
				'writer' : writer,
				'content' : content,
			}

			// 요청 설정
			let url = `http://127.0.0.1:8080/api/boards`

			// FETCH API 로 게시글 등록 요청
			fetch(url, {
				method : 'POST',
				headers : {
					'Content-Type' : 'application/json'
				},
				body : JSON.stringify(data)
			})

			.then( response => {
				return response.text().then( result => ({
					status : response.status,
					result : result
				}))
			})
			
			.then( data => {
				if ( data.status == 201 ) {
					alert(data.result)
					getList()
				}
				else if ( data.status == 400 ) {
					alert('클라이언트의 잘못된 요청')
				}
				else if ( data.status == 500 ) {
					alert('서버 내부 에러')
				}
			})

			.catch( error => {
				log.error('Error : ', error)
				alert('게시글 등록 중 에러가 발생하였습니다.')
			})

		}

		// 게시글 수정
		function update() {
			// 입력 정보
			let no = document.getElementById("input-no").value
			let title = document.getElementById("input-title").value
			let writer = document.getElementById("input-writer").value
			let content = document.getElementById("input-content").value

			// 객체
			let data = {
				'no' : no,
				'title' : title,
				'writer' : writer,
				'content' : content
			}

			// 요청 설정
			let url = `http://127.0.0.1:8080/api/boards`

			// FETCH API 로 게시글 수정 요청
			fetch(url, {
				method : 'PUT',
				headers : { 'Content-Type' : 'application/json'},
				body : JSON.stringify(data)
			})

			.then( response => {
			return response.text().then( result => ({
				status : response.status,
				result : result
				}))
			})
			
			.then( data => {
				if ( data.status == 200 ) {
					alert(data.result)
					getList()
				}
				else if ( data.status == 400 ) {
					alert('클라이언트의 잘못된 요청')
				}
				else if ( data.status == 500 ) {
					alert('서버 내부 에러')
				}
			})

			.catch( error => {
				log.error('Error : ', error)
				alert('게시글 수정 중 에러가 발생하였습니다.')
			})

		}

		// 게시글 삭제
		function remove() {
			// 입력 정보
			let no = document.getElementById("input-no").value

			// DELETE 요청 방식은 요청 데이터를 URL 에 포함하여 전송한다
			// 요청 설정
			let url = `http://127.0.0.1:8080/api/boards/${no}`

			fetch(url, {
				method : 'DELETE',
			})

			.then( response => {
			return response.text().then( result => ({
				status : response.status,
				result : result
				}))
			})
			
			.then( data => {
				if ( data.status == 200 ) {
					alert(data.result)
					getList()
				}
				else if ( data.status == 400 ) {
					alert('클라이언트의 잘못된 요청')
				}
				else if ( data.status == 500 ) {
					alert('서버 내부 에러')
				}
			})

			.catch( error => {
				log.error('Error : ', error)
				alert('게시글 삭제 중 에러가 발생하였습니다.')
			})


		}
		</script>
</body>
</html>